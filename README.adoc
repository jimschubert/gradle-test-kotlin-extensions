= Gradle Test Kotlin Extensions
:toc:
:github-repo-id: gradle-test-kotlin-extensions
:uri-java-ServiceLoader: https://docs.oracle.com/javase/8/docs/api/java/util/ServiceLoader.html
:uri-GradleRunner: https://docs.gradle.org/current/javadoc/org/gradle/testkit/runner/GradleRunner.html
:uri-gradle-userguide: https://docs.gradle.org/current/userguide
:uri-testkit: {uri-gradle-userguide}/test_kit.html
:uri-build-status-image: https://circleci.com/gh/mkobit/{github-repo-id}/tree/master.svg?style=svg
:circle-ci-status-badge: image:{uri-build-status-image}["CircleCI", link="https://circleci.com/gh/mkobit/{github-repo-id}/tree/master"]
:uri-version-badge-image: https://api.bintray.com/packages/mkobit/gradle/{github-repo-id}/images/download.svg
:uri-bintray-package: https://bintray.com/mkobit/gradle/{github-repo-id}/_latestVersion
:uri-zenhub-badge: https://raw.githubusercontent.com/ZenHubIO/support/master/zenhub-badge.png
:version-badge: image:{uri-version-badge-image}["Latest Release Version", link="{uri-bintray-package}"]
:zenhub-badge: image:{uri-zenhub-badge}["ZenHub Badge", link="https://www.zenhub.com/"]

{version-badge}
{circle-ci-status-badge}
{zenhub-badge}

Kotlin extensions and utilities for testing Gradle projects.

== Usage

.Add as a dependency
[source, kotlin]
----
repositories {
  jcenter()
}

dependencies {
  testImplementation("com.mkobit.gradle.test:gradle-test-kotlin-extensions:x.x.x")
}
----

[[gradleRunner-extensions]]
== GradleRunner extensions

link:{uri-GradleRunner}[GradleRunner] can be used to execute builds using the link:{uri-testkit}[Gradle TestKit].
There are a few extensions that make the setup and execution with Kotlin clearer, more concise, and composable.

=== Setup Files in Project Directory

.Setting up file system resources
[source, kotlin]
----
import org.gradle.testkit.runner.BuildResult
import org.gradle.testkit.runner.GradleRunner
import java.io.File
import com.mkobit.gradle.test.kotlin.testkit.runner.setupProjectDir

internal class FunctionalTests {
  @Test
  internal fun `file system manipulation`() {
    val tempDir: File = createTempDir()
    val buildResult = GradleRunner.create().withProjectDir(tempDir).setupProjectDir {
      file("settings.gradle") { content = "// settings.gradle".toByteArray()}
      file("build.gradle") { content = "// build.gradle".toByteArray() }
      directory("src/main/java") {
        file("MainClass.java") { content = "public class Hello {}".toByteArray() }
        directory("com/mkobit/") {
          file("NestedDude.java") {
            content = "package com.mkobit;".toByteArray()
            appendNewline()
            append("public class NestedDude {}")
            appendNewline()
            append("// Additional appended content")
            appendNewline()
          }
        }
      }
    }.build()
    // Assert on BuildResult
  }
}
----

The `file` and `directory` methods can take additional options to `Create`, `Get`, or `MaybeCreate`.
See the `com.mkobit.gradle.test.kotlin.io.FileAction` for other options.

There are also some DSL-friendly methods:

.Setting up file system resources with DSL methods
[source, kotlin]
----
import com.mkobit.gradle.test.kotlin.io.Original
import com.mkobit.gradle.test.kotlin.testkit.runner.setupProjectDir
import org.gradle.testkit.runner.GradleRunner
import org.junit.jupiter.api.Test
import java.io.File

internal class FunctionalTests {
  @Test
  internal fun `file system manipulation`() {
    val tempDir: File = createTempDir()
    val buildResult = GradleRunner.create().withProjectDir(tempDir).setupProjectDir {
      "settings.gradle"(content = "// settings.gradle")
      "build.gradle"(content = "// build.gradle")
      directory("src/main/java") {
        "MainClass.java"(content = "public class Hello {}")
        directory("com/mkobit/") {
          // 'Original' constant here means to not modify any existing content
          "NestedDude.java"(content = Original) {
            content = "package com.mkobit;".toByteArray()
            appendNewline()
            append("public class NestedDude {}${System.lineSeparator()}")
            appendNewline()
            append("// Additional appended content${System.lineSeparator()}")
            appendNewline()
          }
          // 'Original' is the default content, so it does not have to be specified
          "OtherDude.java" {
            content = """
              package com.mkobit;
              public class OtherDude {
              }
            """.trimIndent().toByteArray()
            appendNewline()
          }
        }
      }
    }.build()
    // Assert on BuildResult
  }
}
----

=== Command Line Management

NOTE: These APIs are still experimental and are likely to change after some use.
      They don't provide a complete experience for fully managing command-line arguments right now and feel like a half-way solution.
      This area will be built upon on the future with better support and more use cases.

[source, kotlin]
----
import com.mkobit.gradle.test.kotlin.testkit.runner.build
import com.mkobit.gradle.test.kotlin.testkit.runner.buildAndFail
import com.mkobit.gradle.test.kotlin.testkit.runner.info
import com.mkobit.gradle.test.kotlin.testkit.runner.projectProperties
import com.mkobit.gradle.test.kotlin.testkit.runner.stacktrace
import com.mkobit.gradle.test.kotlin.testkit.runner.systemProperties

internal class FunctionalTests {

  @Test
  internal fun `CLI management`() {
    val gradleRunner = GradleRunner.create().apply {
      info = true
      stacktrace = true
      projectProperties = mapOf("key1" to "prop1")
      systemProperties = mapOf("key2" to "value2")
    }
    // additional setup and execution
    val firstBuild = gradleRunner.build("test", "--tests", "my.test", "assemble")
    // Second build reuses all previous settings that were applied, but does not include arguments from previous `build(...)` invocation
    val secondBuild = gradleRunner.buildAndFail("test", "--tests", "other.test", "assemble")
  }
}
----
